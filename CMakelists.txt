cmake_minimum_required(VERSION 3.5)

set(CMAKE_CXX_EXTENSIONS        NO)
set(CMAKE_CXX_STANDARD          14)
set(CMAKE_CXX_STANDARD_REQUIRED YES)

project(ECMAScript CXX)

option(TESTING "Enable testing" OFF)

set(CMAKE_MODULE_PATH "${CMAKE_CURRENT_LIST_DIR}/cmake")

include(ColorDiagnostics)

if (TESTING)
  include(WarningsAsErrors)
endif ()

set(icu_include_suffixes "include")

add_compile_options(-ferror-limit=1)

find_package(Boost REQUIRED COMPONENTS filesystem program_options)
find_package(ICU   REQUIRED COMPONENTS uc)

include_directories(
  vendor/Catch/include
  vendor/GSL/include
  vendor/variant/include
  ${Boost_INCLUDE_DIRS}
  ${ICU_INCLUDE_DIRS}
)

set(SOURCES
  src/ast.cpp
  src/input_element.cpp
  src/lexer.cpp
  src/matcher.cpp
  src/parser.cpp
  src/token.cpp
)

add_executable(${PROJECT_NAME} src/main.cpp ${SOURCES})
target_link_libraries(${PROJECT_NAME} ${Boost_LIBRARIES} ${ICU_LIBRARIES})

if (TESTING)

  enable_testing()

  file(GLOB TEST_SOURCES "src/*_unittest.cpp")
  add_executable(UnitTest src/test_runner.cpp ${TEST_SOURCES} ${SOURCES})
  # target_compile_definitions(UnitTest PUBLIC CATCH_CONFIG_MAIN)
  target_link_libraries(UnitTest ${Boost_LIBRARIES} ${ICU_LIBRARIES})

  add_test(NAME test COMMAND UnitTest)

endif ()
