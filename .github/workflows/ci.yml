on:
  push:
    branches:
    - main
  pull_request:
    branches:
    - main

jobs:

  test:
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive
    - run: sudo apt-get install ninja-build lcov
    - run: make configure test-report preset=coverage CXX=g++-11"

  build-macos-clang13:
    runs-on: macos-latest
    needs:
      - test
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive
    - run: brew install ninja
    - run: make ci preset=release CXX=clang++

  build-ubuntu-clang12:
    runs-on: ubuntu-latest
    needs:
      - test
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive
    - run: sudo apt-get install ninja-build
    - run: make ci preset=release CXX=clang++-12

  build-ubuntu-gcc11:
    runs-on: ubuntu-22.04
    needs:
      - test
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive
    - run: sudo apt-get install ninja-build
    - run: make ci preset=release CXX=g++-11

  build-windows-msvc:
    runs-on: windows-latest
    needs:
      - test
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive
    - uses: ilammy/msvc-dev-cmd@v1
    - run: choco install ninja
    - run: make ci preset=release CXX=cl

  build-windows-clang:
    runs-on: windows-latest
    needs:
      - test
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive
    - run: choco install ninja
    - run: make ci preset=release CXX=clang++
